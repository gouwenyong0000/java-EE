# HashMap

## Java ä¸­ HashMap çš„æŠ€å·§

------

### ğŸ”¹1. ä½¿ç”¨å±‚é¢çš„æŠ€å·§

1. **åˆç†è®¾ç½®åˆå§‹å®¹é‡**

   - `new HashMap<>(initialCapacity, loadFactor)`
   - å¦‚æœä½ å¤§æ¦‚çŸ¥é“è¦æ”¾å¤šå°‘å…ƒç´ ï¼Œæå‰æŒ‡å®šå®¹é‡ï¼Œé¿å…é¢‘ç¹æ‰©å®¹å’Œ rehashã€‚
   - å…¬å¼ï¼š`å®¹é‡ = é¢„ä¼°å…ƒç´ æ•° / è´Ÿè½½å› å­ + 1`ï¼Œå¸¸ç”¨è´Ÿè½½å› å­æ˜¯ `0.75f`ã€‚

   > **åˆå§‹åŒ–å®¹é‡å…¬å¼**
   >
   > ```java
   > int capacity = (int)(expectedSize / 0.75f) + 1;//é€šè¿‡é¢„æœŸå®¹é‡è®¡ç®—éœ€è¦å®¹é‡
   > Map<String, Integer> map = new HashMap<>(capacity);
   > ```
   >
   > âœ… å‡å°‘æ‰©å®¹æ¬¡æ•°
   > âš ï¸ å®¹é‡å§‹ç»ˆæ˜¯ 2 çš„å¹‚æ¬¡æ–¹ï¼ˆæºç ä¼šè‡ªåŠ¨è°ƒæ•´ï¼‰

---

2. **é¿å…é”®å€¼ä¸ºå¯å˜å¯¹è±¡**

- HashMap çš„ key ä¾èµ–äº `hashCode()` å’Œ `equals()`ï¼Œå¦‚æœ key æ˜¯å¯å˜çš„å¯¹è±¡ï¼Œæ”¾å…¥åä¿®æ”¹å†…å®¹ï¼Œå¯èƒ½å¯¼è‡´æ— æ³•å–å‡ºã€‚
- å¸¸è§å‘ï¼šç”¨ `List`ã€`Set` ä¹‹ç±»å½“ keyï¼Œä¸”å†…å®¹è¢«ä¿®æ”¹ã€‚

> **é¿å…ä½¿ç”¨å¯å˜å¯¹è±¡ä½œä¸º Key**ï¼Œå¦‚ä¸‹ä½¿ç”¨listä½œä¸ºkeyï¼Œæ·»åŠ å…ƒç´ ålistçš„hashå€¼å˜åŒ–
>
> ```java
> List<String> list = new ArrayList<>();
> map.put(list, "test");
> list.add("changed"); // å–ä¸å‡ºæ¥äº†
> ```
>
> âœ… ä½¿ç”¨ä¸å¯å˜å¯¹è±¡ï¼ˆ`String`ã€`Integer`ã€è‡ªå®šä¹‰ä¸å¯å˜ç±»ï¼‰

---

3. é«˜æ•ˆçš„æ“ä½œæ–¹æ³•

| æ–¹æ³•               | åœºæ™¯                | ç¤ºä¾‹                                                     |
| ------------------ | ------------------- | -------------------------------------------------------- |
| `computeIfAbsent`  | åˆå§‹åŒ– value        | `map.computeIfAbsent(k, x -> new ArrayList<>()).add(v);` |
| `computeIfPresent` | ä»…å½“ key å­˜åœ¨æ—¶æ›´æ–° | `map.computeIfPresent(k, (kk,vv) -> vv+1);`              |
| `merge`            | åˆå¹¶å€¼ï¼ˆè®¡æ•°ï¼‰      | `map.merge("apple", 1, Integer::sum);`                   |

---

4. **éå†æ–¹å¼é€‰å¯¹**

- **éå†æœ€é«˜æ•ˆæ–¹å¼**

  ```java
  // éœ€è¦ key å’Œ value  æ¨è `entrySet` éå†æ•ˆç‡æœ€é«˜ã€‚
  for (Map.Entry<String, Integer> e : map.entrySet()) {
      System.out.println(e.getKey() + " = " + e.getValue());
  }
  ```

- **åªè¦ key æˆ– value**

  ```java
  //åªè¦ key
  for (String k : map.keySet()) {}
  //åªè¦ value
  for (Integer v : map.values()) {}
  ```



------

### ğŸ”¹2. æ€§èƒ½ä¼˜åŒ–æŠ€å·§

1. **é¿å…è¿‡åº¦è£…ç®±æ‹†ç®±**
   - å¦‚æœ key æˆ– value æ˜¯ `int` / `long` / `double`ï¼Œè€ƒè™‘ç”¨ `Int2ObjectMap` (fastutil) æˆ– `Trove` ç­‰åº“ã€‚
2. **é«˜å¹¶å‘ç¯å¢ƒä¸è¦ç›´æ¥ç”¨ HashMap**
   - HashMap åœ¨å¤šçº¿ç¨‹ä¸‹å¯èƒ½æ­»å¾ªç¯ã€jdk7ã€‘ã€æ•°æ®ä¸¢å¤±ã€jdk8ã€‘ã€‚
   - ç”¨ `ConcurrentHashMap` æ›¿ä»£ï¼Œæˆ–ç”¨ `Collections.synchronizedMap(map)` åŒ…è£…ã€‚
3. **å‡å°‘ hash å†²çª**
   - è®¾è®¡åˆç†çš„ `hashCode()`ï¼Œé¿å…æ‰€æœ‰ key è½åœ¨åŒä¸€ä¸ªæ¡¶é‡Œã€‚
   - JDK 8 ä¹‹åï¼Œå¦‚æœæŸä¸ªæ¡¶å†…é“¾è¡¨é•¿åº¦è¶…è¿‡ **8**ï¼Œä¼šè½¬ä¸ºçº¢é»‘æ ‘ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡ã€‚
4. **è¿­ä»£è¿‡ç¨‹ä¸­é¿å…ä¿®æ”¹**
   - ä¼šæŠ› `ConcurrentModificationException`ã€‚
   - è§£å†³æ–¹æ³•ï¼šç”¨ `Iterator` çš„ `remove()`ï¼Œæˆ–ç”¨ `ConcurrentHashMap`ã€‚

------

### ğŸ”¹3. æºç ä¸å®ç°å±‚é¢çš„æŠ€å·§





1. **æ‰©å®¹æœºåˆ¶**

   - HashMap çš„å®¹é‡næ€»æ˜¯ **2 çš„å¹‚æ¬¡æ–¹**ï¼ˆ2, 4, 8, 16 ...ï¼‰ï¼Œè¿™æ · `(n - 1) & hash` ä»£æ›¿å–ä½™æ“ä½œï¼Œé«˜æ•ˆå®šä½æ¡¶ã€‚
   - æ‰©å®¹æ—¶æ–°å®¹é‡æ˜¯åŸæ¥çš„ 2 å€ã€‚
   - è§¦å‘æ¡ä»¶ï¼š`size > capacity * loadFactor` (é»˜è®¤ 0.75)

2. **æ‰°åŠ¨å‡½æ•° (hash spreading)**

   - JDK 8 ä¸­ `hash(key) ^ (hash >>> 16)`ï¼Œå‡å°‘ä½ä½ hash å†²çªã€‚

   - > ```java
     > int h = key.hashCode();
     > h = h ^ (h >>> 16); // æ‰°åŠ¨å‡½æ•°
     > ```

3. **æ ‘åŒ– (Treeify)** é“¾è¡¨ â†’ çº¢é»‘æ ‘

   - æ¡¶å†…é“¾è¡¨é•¿åº¦ > 8 ä¸”å®¹é‡ â‰¥ 64 æ—¶ï¼Œé“¾è¡¨ä¼šè½¬ä¸ºçº¢é»‘æ ‘ã€‚
   - å¦‚æœé“¾è¡¨é•¿åº¦é™åˆ° 6 ä»¥ä¸‹ï¼Œä¼šé€€åŒ–ä¸ºé“¾è¡¨ã€‚

4. **Fail-Fast æœºåˆ¶**

   - è¿­ä»£æ—¶å¦‚æœç»“æ„è¢«ä¿®æ”¹ï¼ˆé `iterator.remove`ï¼‰ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ã€‚

     > ```java
     > for (String k : map.keySet()) {
     >     map.put("newKey", 100); // âŒ ConcurrentModificationException
     > }
     > ```
     >
     > âœ… è§£å†³æ–¹æ¡ˆï¼š
     >
     > ```java
     > Iterator<String> it = map.keySet().iterator();
     > while (it.hasNext()) {
     >     it.remove(); // å®‰å…¨åˆ é™¤
     > }
     > ```
     >
     > 

------

### ğŸ”¹4. å¸¸è§å®ç”¨æŠ€å·§åœºæ™¯

- **é¢‘ç‡ç»Ÿè®¡**ï¼ˆå•è¯å‡ºç°æ¬¡æ•°ï¼‰ï¼š

  ```java
  map.merge(word, 1, Integer::sum);
  ```

- **ä¸€é”®å¤šå€¼å­˜å‚¨**ï¼ˆç±»ä¼¼ Multimapï¼‰ï¼š

  ```java
  map.computeIfAbsent(key, k -> new ArrayList<>()).add(value);
  ```

- **LRU ç¼“å­˜æ›¿ä»£æ–¹æ¡ˆ**ï¼ˆLinkedHashMap å®ç°ï¼‰ï¼š

  ```java
  new LinkedHashMap<K,V>(16, 0.75f, true) {
      protected boolean removeEldestEntry(Map.Entry<K,V> eldest) {
          return size() > 100;
      }
  };
  ```



------

## ğŸ”¹ HashMap æ¡¶å®šä½ä¸æ‰©å®¹ä¼˜åŒ–åŸç†

------

### 1. æ¡¶å®šä½çš„ä¼˜åŒ–åŸç†

åœ¨ JDK 8 ä¸­ï¼ŒHashMap ä½¿ç”¨ **æ‰°åŠ¨å‡½æ•°** + **ä½è¿ç®—** æ¥å®šä½æ¡¶çš„ä½ç½®ï¼š

```java
// hash è®¡ç®—
int h = key.hashCode();
h = h ^ (h >>> 16); // æ‰°åŠ¨å‡½æ•°

// æ¡¶ç´¢å¼•è®¡ç®—
int index = (n - 1) & h; // n æ˜¯æ•°ç»„é•¿åº¦ï¼ˆ2 çš„å¹‚ï¼‰
```

#### ğŸš€ ä¼˜åŒ–ç‚¹ï¼š

1. **æ‰°åŠ¨å‡½æ•°ï¼ˆhash spreadingï¼‰**
   - é¿å…ä½ä½åˆ†å¸ƒä¸å‡åŒ€ï¼Œå‡å°‘ hash å†²çªã€‚
   - `h ^ (h >>> 16)` ç­‰ä»·äºæŠŠé«˜ 16 ä½æ··å…¥ä½ 16 ä½ã€‚
2. **ä½è¿ç®—ä»£æ›¿å–æ¨¡**
   - `(n - 1) & h` æ¯” `h % n` æ›´å¿«ï¼Œå› ä¸º `n` å§‹ç»ˆæ˜¯ 2 çš„å¹‚ã€‚
   - ç¤ºä¾‹ï¼šå¦‚æœ `n = 16` (äºŒè¿›åˆ¶ `10000`)ï¼Œ`n - 1 = 1111`ï¼Œç›¸å½“äºåªå– hash çš„å 4 ä½ã€‚

------

### 2. æ‰©å®¹æœºåˆ¶ä¸è¿ç§»ä¼˜åŒ–

#### ğŸš© æ‰©å®¹æ¡ä»¶

- å½“ `size > capacity * loadFactor` æ—¶ï¼Œæ‰©å®¹ä¸ºåŸæ¥çš„ 2 å€ã€‚

#### ğŸš© æ‰©å®¹è¿ç§»è§„åˆ™

åœ¨ **JDK 7 ä¹‹å‰**ï¼ŒHashMap æ‰©å®¹æ—¶ä¼š **é‡æ–°è®¡ç®— hash â†’ å®šä½æ¡¶ â†’ æ’å…¥**ï¼Œæˆæœ¬é«˜ã€‚

**JDK 8 ä¼˜åŒ–ï¼šä¸ç”¨é‡æ–°è®¡ç®— hashï¼Œåªçœ‹ hash çš„æ–°ä½**ï¼š

- æ–°å®¹é‡ = `oldCapacity * 2`
- æ¡¶ä½ç½®åªå¯èƒ½æœ‰ **ä¸¤ä¸ªä½ç½®**ï¼š
  1. **åŸç´¢å¼•ä½ç½® (index)**
  2. **åŸç´¢å¼• + oldCapacity (index + oldCap)**

#### âœ… åŸç†ï¼š

å› ä¸ºæ–°çš„æ¡¶æ•°é‡æ˜¯æ—§æ¡¶çš„ **2 å€**ï¼Œæ‰€ä»¥ `(n - 1) & hash` çš„ç»“æœåªå–å†³äº **å¤šå‡ºæ¥çš„é‚£ä¸€ä½**ï¼ˆé«˜ 1 ä½ï¼‰ï¼š

- å¦‚æœè¯¥ä½æ˜¯ `0` â†’ èŠ‚ç‚¹ä½ç½®ä¸å˜
- å¦‚æœè¯¥ä½æ˜¯ `1` â†’ èŠ‚ç‚¹ç§»åŠ¨åˆ° `index + oldCapacity`

------

### 3. ç¤ºä¾‹å›¾è§£

å‡è®¾ `oldCapacity = 16 (10000b)`ï¼Œæ‰©å®¹åˆ° `32 (100000b)`ï¼š

- æ—§æ¡¶ç´¢å¼•è®¡ç®—ï¼š

  ```
  index = hash & (16 - 1) = hash & 1111b
  ```

- æ–°æ¡¶ç´¢å¼•è®¡ç®—ï¼š

  ```
  newIndex = hash & (32 - 1) = hash & 11111b
  ```

å·®åˆ«åœ¨äº **ç¬¬ 5 ä½ï¼ˆäºŒè¿›åˆ¶ç¬¬ 16 çš„ä½ç½®ï¼‰**ï¼š

- å¦‚æœè¿™ä¸€ä½æ˜¯ `0` â†’ index ä¸å˜
- å¦‚æœè¿™ä¸€ä½æ˜¯ `1` â†’ index = oldIndex + 16

------

#### ğŸŸ¢ ä¸¾ä¾‹

å‡è®¾ä¸€ä¸ªå…ƒç´ çš„ hash å€¼ï¼š

```
hash = 100101b (37)
```

- æ—§å®¹é‡ `16`ï¼š

  ```
  index = hash & 1111b = 0101b = 5
  ```

- æ–°å®¹é‡ `32`ï¼š

  ```
  newIndex = hash & 11111b = 100101b & 11111b = 100101b (37) = 5 + 16 = 21
  ```

â¡ï¸ æ‰€ä»¥è¯¥å…ƒç´ åœ¨æ‰©å®¹åä»æ¡¶ `5` ç§»åŠ¨åˆ°äº†æ¡¶ `21`ã€‚

------

### 4. ä¼˜åŒ–æ•ˆæœ

- **JDK 7 åŠä¹‹å‰**ï¼šè¿ç§»æ—¶æ¯ä¸ªå…ƒç´ éƒ½è¦é‡æ–° hash â†’ å®šä½ â†’ æ’å…¥ï¼ˆå¼€é”€å¤§ï¼‰
- **JDK 8**ï¼šåªéœ€æ£€æŸ¥ hash çš„æŸä¸€ä½ï¼Œå†³å®šç•™åœ¨åŸæ¡¶æˆ–ç§»åŠ¨åˆ° `oldIndex + oldCap`ï¼Œæå¤§ä¼˜åŒ–äº†æ‰©å®¹æ€§èƒ½ã€‚

------

## ğŸ“‘ HashMap é«˜é¢‘é¢è¯•é¢˜æ¸…å•

------

### ğŸ”¹1. åŸºç¡€åŸç†ç±»

1. **HashMap çš„åº•å±‚å®ç°ï¼Ÿ**
   - æ•°ç»„ + é“¾è¡¨ + çº¢é»‘æ ‘ï¼ˆJDK 8 ä¹‹åï¼‰
   - å†²çªæ—¶å…ˆæ”¾é“¾è¡¨ï¼Œé“¾è¡¨é•¿åº¦ > 8 ä¸”æ¡¶å®¹é‡ â‰¥ 64 æ—¶è½¬ä¸ºçº¢é»‘æ ‘ã€‚
2. **HashMap çš„é»˜è®¤åˆå§‹å®¹é‡å’Œè´Ÿè½½å› å­ï¼Ÿ**
   - åˆå§‹å®¹é‡ï¼š16
   - è´Ÿè½½å› å­ï¼š0.75
   - æ‰©å®¹æ¡ä»¶ï¼š`size > capacity * loadFactor`
3. **ä¸ºä»€ä¹ˆ HashMap çš„å®¹é‡æ€»æ˜¯ 2 çš„å¹‚ï¼Ÿ**
   - ä¾¿äºä½¿ç”¨ `(n - 1) & hash` ä»£æ›¿ `% n`ï¼Œæå‡æ€§èƒ½ã€‚
   - è¿™æ ·èƒ½ä¿è¯ hash å‡åŒ€åˆ†å¸ƒåœ¨æ¡¶ä¸­ã€‚

------

### ğŸ”¹2. Hash å†²çªç±»

1. **HashMap å¦‚ä½•è§£å†³ hash å†²çªï¼Ÿ**
   - JDK 7 åŠä»¥å‰ï¼šæ•°ç»„ + é“¾è¡¨
   - JDK 8ï¼šé“¾è¡¨ + çº¢é»‘æ ‘ï¼ˆé“¾è¡¨é•¿åº¦ > 8 â†’ æ ‘åŒ–ï¼›< 6 â†’ é€€åŒ–å›é“¾è¡¨ï¼‰
2. **ä¸ºä»€ä¹ˆè¦ç”¨çº¢é»‘æ ‘ï¼Ÿ**
   - é“¾è¡¨æŸ¥è¯¢ O(n)ï¼Œæç«¯æƒ…å†µä¸‹é€€åŒ–æˆé“¾è¡¨ â†’ æ€§èƒ½å·®
   - çº¢é»‘æ ‘æŸ¥è¯¢ O(log n)ï¼Œæé«˜æ•ˆç‡ã€‚

------

### ğŸ”¹3. æ‰©å®¹ä¸å®šä½ç±»

1. **HashMap çš„æ‰©å®¹æœºåˆ¶ï¼Ÿ**
   - å½“ `size > capacity * loadFactor` â†’ æ‰©å®¹ä¸ºåŸæ¥çš„ 2 å€ã€‚
   - JDK 8 è¿ç§»æ—¶ **ä¸é‡æ–°è®¡ç®— hash**ï¼Œåªæ ¹æ®æ–°çš„ä¸€ä½åˆ¤æ–­ï¼š
     - `0` â†’ ç•™åœ¨åŸæ¡¶
     - `1` â†’ ç§»åˆ° `oldIndex + oldCap`
2. **HashMap çš„ key å®šä½æ¡¶çš„è¿‡ç¨‹ï¼Ÿ**
   - è®¡ç®— `hashCode` â†’ æ‰°åŠ¨å‡½æ•° `h ^ (h >>> 16)` â†’ `(n - 1) & hash` å®šä½æ¡¶ã€‚

------

### ğŸ”¹4. å¹¶å‘é—®é¢˜ç±»

1. **ä¸ºä»€ä¹ˆ HashMap çº¿ç¨‹ä¸å®‰å…¨ï¼Ÿ**
   - å¤šçº¿ç¨‹ put æ—¶å¯èƒ½å¯¼è‡´ï¼š
     - æ•°æ®ä¸¢å¤±ï¼ˆè¦†ç›–ï¼‰
     - æ‰©å®¹æ—¶é“¾è¡¨å½¢æˆç¯ï¼Œé€ æˆæ­»å¾ªç¯ï¼ˆJDK 7 å¸¸è§é—®é¢˜ï¼‰
2. **çº¿ç¨‹å®‰å…¨çš„æ›¿ä»£æ–¹æ¡ˆï¼Ÿ**
   - `ConcurrentHashMap`ï¼ˆæ¨èï¼‰
   - `Collections.synchronizedMap(new HashMap<>())`ï¼ˆæ€§èƒ½å·®ï¼‰
3. **ConcurrentHashMap å’Œ HashMap çš„åŒºåˆ«ï¼Ÿ**

- HashMapï¼šæ•°ç»„ + é“¾è¡¨/çº¢é»‘æ ‘ï¼Œçº¿ç¨‹ä¸å®‰å…¨
- ConcurrentHashMapï¼šåˆ†æ®µé”ï¼ˆJDK 7ï¼‰ï¼ŒCAS + synchronizedï¼ˆJDK 8ï¼‰ï¼Œçº¿ç¨‹å®‰å…¨

------

### ğŸ”¹5. æºç æœºåˆ¶ç±»

1. **ä¸ºä»€ä¹ˆè¦æœ‰æ‰°åŠ¨å‡½æ•° (hash spreading)ï¼Ÿ**

- é¿å…é«˜ä½ hash å¤±æ•ˆï¼Œåªç”¨ä½ä½å¯¼è‡´å†²çªé›†ä¸­ã€‚
- `h ^ (h >>> 16)` èƒ½è®©é«˜ 16 ä½å‚ä¸è¿ç®—ã€‚

1. **Fail-Fast æœºåˆ¶æ˜¯ä»€ä¹ˆï¼Ÿ**

- è¿­ä»£ HashMap æ—¶ï¼Œå¦‚æœç»“æ„è¢«ä¿®æ”¹ï¼ˆéè¿­ä»£å™¨çš„ remove æ–¹æ³•ï¼‰ï¼Œä¼šæŠ› `ConcurrentModificationException`ã€‚
- é€šè¿‡ `modCount` ç›‘æ§ç»“æ„å˜åŒ–å®ç°ã€‚

1. **ä¸ºä»€ä¹ˆé“¾è¡¨æ ‘åŒ–é˜ˆå€¼æ˜¯ 8ï¼Ÿ**

- æ ¹æ®æ³Šæ¾åˆ†å¸ƒåˆ†æï¼Œåœ¨è´Ÿè½½å› å­ 0.75 ä¸‹ï¼Œé“¾è¡¨é•¿åº¦è¶…è¿‡ 8 çš„æ¦‚ç‡éå¸¸ä½ã€‚
- è¶…è¿‡ 8 æ—¶ï¼Œæ€§èƒ½é£é™©å¤§äºè½¬æ¢æˆæœ¬ï¼Œæ‰€ä»¥è½¬çº¢é»‘æ ‘ã€‚

------

### ğŸ”¹6. å®æˆ˜ç±»

1. **å¦‚ä½•å®ç°ä¸€ä¸ª LRU ç¼“å­˜ï¼Ÿ**

- ç”¨ `LinkedHashMap`ï¼Œå¼€å¯ `accessOrder=true`ï¼Œé‡å†™ `removeEldestEntry` æ–¹æ³•ã€‚

1. **HashMap å’Œ Hashtable çš„åŒºåˆ«ï¼Ÿ**

- Hashtableï¼šçº¿ç¨‹å®‰å…¨ï¼ˆsynchronizedï¼‰ï¼Œæ€§èƒ½å·®ï¼Œä¸å…è®¸ null key/valueã€‚
- HashMapï¼šçº¿ç¨‹ä¸å®‰å…¨ï¼Œæ€§èƒ½å¥½ï¼Œå…è®¸ä¸€ä¸ª null key å’Œå¤šä¸ª null valueã€‚

1. **HashMap å’Œ TreeMap çš„åŒºåˆ«ï¼Ÿ**

- HashMapï¼šæ— åºï¼ŒåŸºäº hashã€‚
- TreeMapï¼šæœ‰åºï¼ŒåŸºäºçº¢é»‘æ ‘ï¼ŒæŒ‰ç…§ key çš„è‡ªç„¶é¡ºåºæˆ–æ¯”è¾ƒå™¨æ’åºã€‚

------

âœ… æ€»ç»“ï¼š

- åˆçº§é¢è¯•ï¼šHashMap åº•å±‚åŸç† + é»˜è®¤å‚æ•° + Hash å†²çª
- ä¸­çº§é¢è¯•ï¼šæ‰©å®¹æœºåˆ¶ + æ‰°åŠ¨å‡½æ•° + Fail-Fast
- é«˜çº§é¢è¯•ï¼šçº¿ç¨‹å®‰å…¨é—®é¢˜ + JDK 7 æ­»å¾ªç¯é—®é¢˜ + çº¢é»‘æ ‘ä¼˜åŒ–åŸç†



------

# ConcurrentHashMap JDK1.7 vs JDK1.8

## 1. æ•°æ®ç»“æ„å·®å¼‚

### JDK 1.7

- **åˆ†æ®µé”æœºåˆ¶ (Segment + HashEntry æ•°ç»„)**
  - `ConcurrentHashMap` å†…éƒ¨åˆ†ä¸º **è‹¥å¹² Segment**ï¼ˆé»˜è®¤ 16ï¼‰ã€‚
  - æ¯ä¸ª Segment ç±»ä¼¼äºä¸€ä¸ªå°çš„ `HashMap`ï¼Œå†…éƒ¨æ˜¯ **æ•°ç»„ + é“¾è¡¨**ã€‚
  - å¹¶å‘æ§åˆ¶åœ¨ Segment ä¸Šï¼ŒåŠ é”ç²’åº¦è¾ƒç²—ã€‚
  - `size()` æ“ä½œéœ€è¦éå†æ‰€æœ‰ Segment å¹¶åŠ é”ï¼Œå¼€é”€å¤§ã€‚

### JDK 1.8

- **å–æ¶ˆ Segmentï¼Œé‡‡ç”¨ Node æ•°ç»„ + é“¾è¡¨ + çº¢é»‘æ ‘**
  - ä¸ `HashMap 1.8` ç±»ä¼¼ï¼Œæ¡¶å†²çªæ—¶é“¾è¡¨é•¿åº¦è¶…è¿‡ **8** è½¬æ¢ä¸ºçº¢é»‘æ ‘ã€‚
  - å¹¶å‘æ§åˆ¶æ–¹å¼æ”¹ä¸º **CAS + synchronized (é”ç²’åº¦åœ¨æ¡¶/Node çº§åˆ«)**ï¼Œå¤§å¤§å‡å°‘é”ç«äº‰ã€‚
  - `size()` é€šè¿‡ `baseCount + counterCells`ï¼ˆç±»ä¼¼ LongAdderï¼‰è¿›è¡Œç»Ÿè®¡ï¼Œæ•ˆç‡æ›´é«˜ã€‚

------

## 2. åŠ é”æœºåˆ¶å·®å¼‚

### JDK 1.7

- **Segment é”**
  - åŸºäº **ReentrantLock** å®ç°ã€‚
  - åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®æŸä¸ª Segmentã€‚
  - å¤šçº¿ç¨‹è®¿é—®ä¸åŒ Segment æ—¶èƒ½å¹¶å‘æ‰§è¡Œï¼Œä½† Segment æ•°é‡æœ‰é™ï¼ˆé»˜è®¤ 16ï¼‰ï¼Œé«˜å¹¶å‘ä¸‹ä¼šæœ‰é”ç«äº‰ã€‚

### JDK 1.8

- **CAS + synchronized**
  - æ’å…¥æ•°æ®æ—¶ï¼Œå…ˆç”¨ **CAS** å°è¯•å†™å…¥ç©ºæ¡¶ã€‚
  - å¦‚æœå¤±è´¥æˆ–éœ€è¦é“¾è¡¨æ“ä½œï¼Œåˆ™ä½¿ç”¨ `synchronized` é”å®š **æ¡¶çš„å¤´ç»“ç‚¹**ï¼Œä¸æ˜¯æ•´ä¸ª Segmentã€‚
  - é”ç²’åº¦æ›´å°ï¼Œå†²çªæ¦‚ç‡æ›´ä½ï¼Œæ€§èƒ½æ›´å¥½ã€‚

------

## 3. æ‰©å®¹æœºåˆ¶

### JDK 1.7

- **åˆ†æ®µæ‰©å®¹**
  - æ¯ä¸ª Segment ç‹¬ç«‹æ‰©å®¹ã€‚
  - æ‰©å®¹æ—¶ä¼šé‡æ–°è®¡ç®— hashï¼Œè¿ç§»æ•°æ®åˆ°æ–°æ•°ç»„ã€‚
  - å®¹æ˜“å‡ºç° â€œæ‰©å®¹é£æš´â€ + **rehash å¼€é”€å¤§**ã€‚

### JDK 1.8

- **å…¨è¡¨æ‰©å®¹ + å¤šçº¿ç¨‹ååŠ©è¿ç§»**
  - é‡‡ç”¨ç±»ä¼¼ `HashMap` çš„æ‰©å®¹æ–¹å¼ã€‚
  - æ‰©å®¹æ—¶å¤šä¸ªçº¿ç¨‹å¯åŒæ—¶å‚ä¸æ•°æ®è¿ç§»ï¼Œå‡è½»å•çº¿ç¨‹æ‰©å®¹å‹åŠ›ã€‚
  - åˆ©ç”¨ `ForwardingNode` æ ‡è®°å·²ç»è¿ç§»çš„æ¡¶ã€‚

------

## 4. Null Key / Null Value

- JDK1.7 å’Œ JDK1.8 éƒ½ **ä¸å…è®¸ key æˆ– value ä¸º null**
  - å› ä¸ºæ— æ³•åŒºåˆ†æ˜¯ key æœ¬èº«ä¸º nullï¼Œè¿˜æ˜¯å¹¶å‘ä¸‹æŸ¥ä¸åˆ°å€¼ã€‚

------

## ğŸ“Œ é«˜é¢‘é¢è¯•é¢˜

#### Q1: JDK1.7 å’Œ JDK1.8 çš„ `ConcurrentHashMap` çš„æœ€å¤§åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

- JDK1.7 ä½¿ç”¨ **Segment åˆ†æ®µé”**ï¼Œé”ç²’åº¦å¤§ï¼›
- JDK1.8 ä½¿ç”¨ **CAS + synchronized é”æ¡¶**ï¼Œé”ç²’åº¦å°ï¼Œæ€§èƒ½æ›´ä¼˜ã€‚

------

#### Q2: ä¸ºä»€ä¹ˆ JDK1.8 æŠ›å¼ƒäº† Segmentï¼Ÿ

- Segment ç²’åº¦è¾ƒå¤§ï¼ˆé»˜è®¤ 16 ä¸ªï¼‰ï¼Œé«˜å¹¶å‘ä¸‹ä»ä¼šäº§ç”Ÿç«äº‰ã€‚
- CAS + synchronized åœ¨ JDK1.6 ä¹‹åæ•ˆç‡æ›´é«˜ï¼Œé”ä¼˜åŒ–ï¼ˆåå‘é”ã€è½»é‡çº§é”ï¼‰ä½¿ synchronized ä¸å†æ˜¯æ€§èƒ½ç“¶é¢ˆã€‚

------

#### Q3: JDK1.8 ä¸­ä¸ºä»€ä¹ˆå¼•å…¥çº¢é»‘æ ‘ï¼Ÿ

- é“¾è¡¨æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦ O(n)ï¼Œæç«¯æƒ…å†µä¸‹ä¼šé€€åŒ–ä¸º O(n)ã€‚
- çº¢é»‘æ ‘æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦ O(log n)ï¼Œå¤§å¤§æå‡æŸ¥è¯¢æ€§èƒ½ã€‚

------

#### Q4: `size()` åœ¨ JDK1.7 å’Œ JDK1.8 çš„å®ç°æœ‰ä½•ä¸åŒï¼Ÿ

- JDK1.7ï¼šéœ€è¦éå†æ‰€æœ‰ Segment å¹¶åŠ é”ï¼Œç»Ÿè®¡æ‰€æœ‰å…ƒç´ æ•°é‡ã€‚
- JDK1.8ï¼šä½¿ç”¨ **baseCount + CounterCell (ç±»ä¼¼ LongAdder)**ï¼Œé€šè¿‡ CAS æ›´æ–°è®¡æ•°ï¼Œæ›´é«˜æ•ˆã€‚

------

#### Q5: `ConcurrentHashMap` ä¸ºä»€ä¹ˆä¸èƒ½å­˜å‚¨ null key å’Œ null valueï¼Ÿ

- null keyï¼šéš¾ä»¥åŒºåˆ† `map.get(null)` è¿”å› null æ˜¯ key ä¸å­˜åœ¨è¿˜æ˜¯ key å¯¹åº”çš„ value ä¸º nullã€‚
- null valueï¼šåŒæ ·éš¾ä»¥åŒºåˆ† key å¯¹åº”çš„å€¼æ˜¯å¦ä¸º nullï¼Œè¿˜æ˜¯æ²¡æœ‰è¯¥ keyã€‚
- åœ¨å¹¶å‘åœºæ™¯ä¸‹ï¼Œæ¨¡ç³Šä¸æ¸…ä¼šå¯¼è‡´æ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚

------

#### Q6: æ‰©å®¹æ—¶ JDK1.8 å¦‚ä½•é¿å…é˜»å¡æ‰€æœ‰çº¿ç¨‹ï¼Ÿ

- é‡‡ç”¨ **åˆ†æ®µè¿ç§»æœºåˆ¶**ï¼šå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è¿ç§»ä¸åŒæ¡¶çš„æ•°æ®ï¼›
- ä½¿ç”¨ `ForwardingNode` å ä½ï¼Œæ ‡è®°å·²è¿ç§»å®Œæˆçš„æ¡¶ï¼Œé˜²æ­¢é‡å¤è¿ç§»ã€‚

------

âš¡æ€»ç»“ä¸€å¥è¯ï¼š

> **JDK1.7ï¼šSegment + ReentrantLock + é“¾è¡¨ï¼Œæ‰©å®¹ä½æ•ˆ**
>  **JDK1.8ï¼šCAS + synchronized + é“¾è¡¨/çº¢é»‘æ ‘ï¼Œæ”¯æŒå¤šçº¿ç¨‹æ‰©å®¹ï¼Œæ€§èƒ½æ›´ä¼˜**

------

